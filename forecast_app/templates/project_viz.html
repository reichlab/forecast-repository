{% extends "base.html" %}

{% block title %}Project viz: {{ project.name }}{% endblock %}

{% block head %}
    <!-- zoltar_viz -->
    <script src="https://cdn.plot.ly/plotly-2.12.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.3/moment.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/reichlab/predtimechart@1.1.3/predtimechart.css">
{% endblock %}

{% block content %}

    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'projects' %}">Home</a></li>
            <li class="breadcrumb-item"><a href="{{ project.get_absolute_url }}">{{ project.name }}</a></li>
            <li class="breadcrumb-item active">Viz</li>
        </ol>
    </nav>

    <div id="forecastViz_row" class="row">
        {# the div passed to zoltar_viz.js initialize(), which populates all DOM elements #}
    </div>


    <script type="module">
        import App from 'https://cdn.jsdelivr.net/gh/reichlab/predtimechart@1.1.3/predtimechart.js';

        /***
         * Makes an AJAX call to the Zoltar API to fetch truth or forecast data using the passed args, which correspond to those
         * of `utils.visualization.viz_data()` (see). The `success` and `error` callbacks are passed directly to the $.ajax()
         * call and therefore accept the standard arguments:
         * - success: function (data, textStatus, jqXHR) { ... }
         * - error: function (jqXHR, textStatus, thrownError) { ... }
         */
        function _fetchData(isForecast, targetKey, unitAbbrev, referenceDate) {
            const url = "/api/project/" + {{ project.id }} +"/viz-data/";
            const requestData = {
                is_forecast: isForecast,
                target_key: targetKey,
                unit_abbrev: unitAbbrev,
                reference_date: referenceDate,
            };

            // using https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch
            const urlObj = new URL(url, document.location.origin);
            Object.keys(requestData).forEach(key => urlObj.searchParams.append(key, requestData[key]))
            return fetch(urlObj);  // Promise
        }

        /**
         * Human judgement ensemble model function that does an AJAX call to the Zoltar API to compute forecast CSV
         * data for the passed args.
         *
         * @private
         */
        function _calcUemForecasts(componentModels, targetKey, referenceDate, userModelName) {
            const url = "/api/project/" + {{ project.id }} +"/viz-human-ensemble-model/";
            const urlObj = new URL(url, document.location.origin);
            urlObj.searchParams.append('target_key', targetKey);
            urlObj.searchParams.append('reference_date', referenceDate);
            urlObj.searchParams.append('user_model_name', userModelName);
            componentModels.forEach((model) => {
                urlObj.searchParams.append('component_model', model);
            });
            console.debug('_calcUemForecasts()', componentModels, targetKey, referenceDate, '.', urlObj.toString());
            return fetch(urlObj);  // Promise
        }

        // componentDiv, _fetchData, isIndicateRedraw, options, _calcUemForecasts:
        App.initialize('forecastViz_row', _fetchData, true, {{ options|safe }}, _calcUemForecasts);

    </script>

{% endblock %}
